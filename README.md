# Memorandum for FreeBSD/tunnel/PF/nginx on jail(http/2) 


* 現象:

1. あるリモート(物理的にはNTTフレッツで対外接続）されているFreeBSD の 単体サーバに ppp-over-ip tunnel で公開IPアドレスを持たせている。
1. サーバ上に FreeBSD/Jail をいくつか配置した。
1. サーバで FreeBSD/Jail のIPアドレスに向け、 PF で 443/tcp のトラフィックをリダイレクトしている。
1. この状況でSNI/TLS 設定を施した nginxリバースプロキシ（TLS/SNI対応）を設定した。
1. 更に別の jail で 80/tcp のサービスを実施し、nginxコンテンツサーバを稼働。
1. 本日(2025/09/08) の午後から、HTTP/2の設定を試みた。
1. nginx リバースプロキシの設定を HTTP/2 に変更するとパケットが流れない
1. コンテンツサーバ、リバースプロキシを設定したそれぞれの nginx ログを見る限り、エラーになっておらず、パケットは正常に送られたことになっている（？）
1. モダンなブラウザ上にはデータが送られない。
1. SNIに対応しているか不明な w3m などの旧いSSL(http1.1?) のみ対応しているテキストブラウザではアクセスできた。
1. リバースプロキシの問題と考え、リバースプロキシを経由しない形に変更した直後は HTTP/2 での接続ができていたが、しばらくすると繋がらなくなってしまう。
1. コンテンツサーバは、wordpress なので、ループバックのアクセスが阻害している可能性を鑑みて、設定を簡略にしたが改善しない。
1. HTTP/1.1 であれば問題がないので、nginxのバージョンに依存する可能性を探ったが、1.29から1.26の各バージョンで同じような挙動（HTTP/1.1で動作しHTTP/2では動かない）状態。
1. 同じように、quic の設定も行ってみたが、HTTP/2 が動かない時点でリバースプロキシーで動かない。

# 考察
1. 本日午前中に　作業環境手前側のルータ　の　pf の設定次第では、quic(UDP)で繋がらないブラウザがあったことが判明した。PFでUDPのフォワーディング処理に対するパケット加工（パケットのソースIPアドレス書き換え）を行っているので、パケット整列が随時行われていると思われる。そこに quic プロトコルのような セッション管理しないものに対しての「内部的なセッション管理」が、上位のプロトコルである QUIC に干渉する可能性が認識された。
# その他
1. FreeBSD/pf はCG-NATとは性格が異なり、近年のLinux実装と比べるとVRFなどで若干使い勝手が悪く、ルータでの利用が減っていて、コンシューマレベルの管理技術ではルータとしての利用が難しくなっていると思われる。

